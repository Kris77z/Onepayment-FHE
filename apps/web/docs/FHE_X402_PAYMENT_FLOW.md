# FHE + x402 ç»„åˆæ”¯ä»˜æµç¨‹è¯´æ˜

**æ—¥æœŸ**: 2024-12-17  
**ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ æ¦‚è¿°

FHE + x402 ç»„åˆæ”¯ä»˜å®ç°äº†**æœºå¯† Gasless æ”¯ä»˜**ï¼Œç»“åˆäº†ï¼š
- **x402 åè®®**ï¼šGasless æ”¯ä»˜ï¼Œç”± Facilitator ä»£ä»˜ gas è´¹ç”¨
- **FHE åŠ å¯†**ï¼šä¿æŠ¤æ”¯ä»˜é‡‘é¢éšç§ï¼Œæ”¯æŒåŒæ€è®¡ç®—

---

## ğŸ”„ æ”¯ä»˜æµç¨‹

### FHE + x402 ç»„åˆæ”¯ä»˜æµç¨‹

```
ç”¨æˆ·å‘èµ·æ”¯ä»˜
    â†“
1. åŠ å¯†é‡‘é¢ï¼ˆFHEï¼‰
    â†“
2. é€šè¿‡ x402 è¿›è¡Œå®é™…çš„ USDC è½¬è´¦ï¼ˆGaslessï¼‰
    â”œâ”€ ç”¨æˆ·ç­¾åæ”¯ä»˜æˆæƒï¼ˆEIP-3009ï¼‰
    â”œâ”€ Facilitator éªŒè¯å¹¶ç»“ç®—
    â””â”€ å®é™…çš„ USDC ä»ç”¨æˆ·è´¦æˆ·è½¬ç§»åˆ°æ”¶æ¬¾è´¦æˆ·
    â†“
3. å°†åŠ å¯†é‡‘é¢å­˜å‚¨åˆ° FHE åˆçº¦ï¼ˆç”¨äºéšç§ä¿æŠ¤ï¼‰
    â”œâ”€ åŠ å¯†é‡‘é¢å­˜å‚¨åˆ° FHEPaymentGateway åˆçº¦
    â””â”€ æ”¯æŒåç»­çš„åŒæ€è®¡ç®—ï¼ˆç´¯è®¡ã€æ±‡ç‡æ¢ç®—ç­‰ï¼‰
    â†“
4. è®°å½•äº¤æ˜“å†å²
    â”œâ”€ x402 äº¤æ˜“å“ˆå¸Œï¼ˆä¸»è¦ï¼‰
    â”œâ”€ FHE å­˜å‚¨äº¤æ˜“å“ˆå¸Œ
    â””â”€ åŠ å¯†é‡‘é¢å…ƒæ•°æ®
```

### çº¯ x402 æ”¯ä»˜æµç¨‹ï¼ˆå¯¹æ¯”ï¼‰

```
ç”¨æˆ·å‘èµ·æ”¯ä»˜
    â†“
1. é€šè¿‡ x402 è¿›è¡Œå®é™…çš„ USDC è½¬è´¦ï¼ˆGaslessï¼‰
    â”œâ”€ ç”¨æˆ·ç­¾åæ”¯ä»˜æˆæƒï¼ˆEIP-3009ï¼‰
    â”œâ”€ Facilitator éªŒè¯å¹¶ç»“ç®—
    â””â”€ å®é™…çš„ USDC ä»ç”¨æˆ·è´¦æˆ·è½¬ç§»åˆ°æ”¶æ¬¾è´¦æˆ·
    â†“
2. è®°å½•äº¤æ˜“å†å²
    â””â”€ x402 äº¤æ˜“å“ˆå¸Œ
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. Gasless æ”¯ä»˜
- âœ… ç”¨æˆ·æ— éœ€æ”¯ä»˜ gas è´¹ç”¨
- âœ… Facilitator ä»£ä»˜ gasï¼Œæä¾› Web2 çº§ç”¨æˆ·ä½“éªŒ

### 2. éšç§ä¿æŠ¤
- âœ… æ”¯ä»˜é‡‘é¢åŠ å¯†å­˜å‚¨
- âœ… æ”¯æŒåŒæ€è®¡ç®—ï¼Œæ— éœ€è§£å¯†å³å¯è¿›è¡Œè¿ç®—
- âœ… ä¿æŠ¤ç”¨æˆ·æ”¯ä»˜éšç§

### 3. åŒé‡ä»·å€¼
- âœ… **Gasless**ï¼šé€šè¿‡ x402 å®ç°é›¶ gas è´¹ç”¨
- âœ… **æœºå¯†**ï¼šé€šè¿‡ FHE å®ç°é‡‘é¢éšç§ä¿æŠ¤

---

## ğŸ’» ä»£ç å®ç°

### å‰ç«¯æ”¯ä»˜ç»„ä»¶

```typescript
if (useFHE) {
  // Step 1: Encrypt amount using FHE
  const encrypted = await encryptAmountFHEVM(amountInt, contractAddress, address);
  
  // Step 2: Make x402 payment with FHE encrypted amount metadata
  const response = await x402Client.request(endpoint, {
    method: 'GET',
    headers: {
      'X-FHE-ENCRYPTED': encryptedValue, // Pass encrypted amount as metadata
    },
  });
  
  // Step 3: Store encrypted amount to FHE contract
  const fheTxHash = await addPayment(client, address, encryptedValue);
  
  // Step 4: Record transaction
  // ...
}
```

### x402 å®¢æˆ·ç«¯

x402 å®¢æˆ·ç«¯æ”¯æŒåœ¨è¯·æ±‚å¤´ä¸­ä¼ é€’ FHE åŠ å¯†é‡‘é¢ï¼š

```typescript
headers: {
  'X-FHE-ENCRYPTED': encryptedValue, // FHE encrypted amount
}
```

---

## ğŸ“Š äº¤æ˜“è®°å½•

### äº¤æ˜“ç±»å‹

- **ç±»å‹**: `fhe_payment`
- **ä¸»è¦äº¤æ˜“å“ˆå¸Œ**: x402 äº¤æ˜“å“ˆå¸Œï¼ˆå®é™…çš„ USDC è½¬è´¦ï¼‰
- **FHE äº¤æ˜“å“ˆå¸Œ**: FHE åˆçº¦å­˜å‚¨äº¤æ˜“å“ˆå¸Œ

### å…ƒæ•°æ®

```typescript
{
  endpoint: '/api/premium',
  description: 'FHE + x402 æ”¯ä»˜: 0.01 USDC',
  amount: '0.01',
  x402TxHash: '0x...', // x402 äº¤æ˜“å“ˆå¸Œ
  fheTxHash: '0x...',  // FHE å­˜å‚¨äº¤æ˜“å“ˆå¸Œ
  settlement: { ... }, // x402 settlement ä¿¡æ¯
}
```

---

## ğŸ” éªŒè¯æ–¹å¼

### 1. x402 äº¤æ˜“éªŒè¯

åœ¨ Basescan ä¸ŠæŸ¥çœ‹ x402 äº¤æ˜“å“ˆå¸Œï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š
- âœ… å®é™…çš„ USDC è½¬è´¦
- âœ… ä»ç”¨æˆ·è´¦æˆ·åˆ°æ”¶æ¬¾è´¦æˆ·
- âœ… Facilitator ä»£ä»˜ gas

### 2. FHE å­˜å‚¨éªŒè¯

åœ¨ Basescan ä¸ŠæŸ¥çœ‹ FHE äº¤æ˜“å“ˆå¸Œï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š
- âœ… è°ƒç”¨ `FHEPaymentGateway.addPayment`
- âœ… åŠ å¯†é‡‘é¢å­˜å‚¨åˆ°åˆçº¦
- âœ… è§¦å‘ `PaymentAdded` äº‹ä»¶

### 3. ä½™é¢éªŒè¯

- âœ… USDC ä½™é¢åº”è¯¥å‡å°‘ï¼ˆå®é™…è½¬è´¦ï¼‰
- âœ… FHE åŠ å¯†ä½™é¢åº”è¯¥å¢åŠ ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. USDC ä½™é¢è¦æ±‚

- FHE + x402 ç»„åˆæ”¯ä»˜éœ€è¦ç”¨æˆ·æœ‰è¶³å¤Ÿçš„ USDC ä½™é¢
- x402 æ”¯ä»˜ä¼šå®é™…æ‰£é™¤ USDCï¼Œä¸æ˜¯æ¨¡æ‹Ÿæ”¯ä»˜

### 2. ç½‘ç»œè¦æ±‚

- å¿…é¡»åœ¨ Base Sepolia æµ‹è¯•ç½‘ç»œä¸Š
- éœ€è¦è¿æ¥åˆ°æ­£ç¡®çš„ç½‘ç»œæ‰èƒ½è¿›è¡Œæ”¯ä»˜

### 3. åŠ å¯†é‡‘é¢æ ¼å¼

- åŠ å¯†é‡‘é¢ä»¥ `euint32` æ ¼å¼å­˜å‚¨
- é‡‘é¢å•ä½ï¼šcentsï¼ˆä¾‹å¦‚ï¼š$0.01 = 1 centï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [x402 åè®®æ–‡æ¡£](../../x402-fhe-gateway-evm/docs/integration-evm/x402-setup.md)
- [FHE é›†æˆæ–‡æ¡£](../../x402-fhe-gateway-evm/docs/fhe/reports/fhe-integration-plan.md)
- [å®æ–½æ–¹æ¡ˆæ–‡æ¡£](../../x402-fhe-gateway-evm/docs/reports/ç»ˆæé›†æˆå®æ–½æ–¹æ¡ˆï¼šx402 + FHE Gateway (EVM).md)

---

**æœ€åæ›´æ–°**: 2024-12-17  
**çŠ¶æ€**: âœ… å·²å®ç°

